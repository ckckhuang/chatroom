<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>無內容</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {font-family:"Microsoft JhengHei",sans-serif;margin:0;height:100vh;background:#e5e5e5;display:flex;justify-content:center;align-items:center;color:#333}
    .chat-container{width:600px;height:80vh;display:flex;flex-direction:column;background:rgba(255,255,255,0.95);border-radius:12px;box-shadow:0 4px 20px rgba(0,0,0,0.15);overflow:hidden}
    #chat{flex:1;overflow-y:auto;padding:15px;display:flex;flex-direction:column;gap:10px}
    .message-container{max-width:70%;display:flex;flex-direction:column;gap:2px;position:relative}
    .my-message{align-self:flex-end}
    .other-message{align-self:flex-start}
    .bubble{padding:8px 12px;border-radius:10px;font-size:12px;word-wrap:break-word}
    .my-message .bubble{background:rgb(232,235,250);color:#1a1a1a;border-radius:10px 10px 3px 10px;border:1px solid rgba(0,120,212,0.15);box-shadow:0 1px 3px rgba(0,0,0,0.05)}
    .other-message .bubble{background:#f0f0f0;color:#333;border-radius:10px 10px 3px 10px;border:1px solid #ddd}
    .username{font-size:12px;font-weight:bold;color:#0078d4}
    .meta{font-size:11px;color:#666;text-align:right}
    .reply-preview{font-size:11px;color:#666;background:#f0f0f0;border-left:3px solid #0078d4;padding:2px 6px;border-radius:4px;margin-bottom:2px}
    .input-area{display:flex;padding:10px;background:#f9f9f9;border-top:1px solid #ccc;gap:8px;align-items:center}
    input[type=text]{flex:1;padding:8px;border-radius:6px;border:1px solid #ccc;background:#fff;color:#333;outline:none;font-size:14px}
    #username{width:100px}
    #sendBtn{width:36px;height:36px;border:1px solid #ccc;border-radius:50%;background:transparent;display:flex;justify-content:center;align-items:center;cursor:pointer;padding:0;transition:all .15s}
    #sendBtn:hover{background-color:#e6f0ff;border-color:#0078d4}
    #sendBtn svg{width:18px;height:18px;fill:#0078d4;transition:fill .15s}
    #sendBtn:hover svg{fill:#005fa3}
    .topbar{display:flex;justify-content:space-between;padding:10px;border-bottom:1px solid #eee;background:#fff}
    .logout{font-size:13px;color:#0078d4;text-decoration:none}
    .small-note{font-size:12px;color:#666;margin-left:8px}
    .reply-button {
      background: none;
      border: none;
      color: #0078d4; /* 與 .logout 相同 */
      font-size: 13px;  /* 與 .logout 相同 */
      cursor: pointer;
      padding: 0;
      margin-left: 8px; /* 調整間距 */
      text-decoration: none; /* 與 .logout 相同 */
    }
    .reply-button:hover {
      text-decoration: underline; /* 滑鼠懸停時加上底線 */
    }
  </style>
</head>
<body>
  <div class="chat-container">
    <div class="topbar">
      <div>您好，<strong>{{ nickname }}</strong><span class="small-note">（已登入）</span></div>
      <div><a class="logout" href="/logout">登出</a></div>
    </div>

    <div id="chat"></div>

    <div class="input-area">
      <input id="message" type="text" placeholder="輸入訊息..." autocomplete="off">
      <button id="sendBtn" onclick="send()">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z"/></svg>
      </button>
    </div>
  </div>

  <script>
    const socket = io();
    const username = "{{ nickname|e }}";
    let replyToId = null;

    let lastNotificationTime = 0;
    const NOTIFY_INTERVAL = 10 * 60 * 1000;
    let isPageVisible = true;
    document.addEventListener("visibilitychange", () => { isPageVisible = !document.hidden; });

    function showNotification() {
      const now = Date.now();
      if (now - lastNotificationTime < NOTIFY_INTERVAL) return;
      lastNotificationTime = now;
      if (Notification.permission === "granted") {
        new Notification("您有新訊息", { body: "點擊可查看最新討論內容。", icon: "https://cdn-icons-png.flaticon.com/512/847/847969.png" });
      } else if (Notification.permission !== "denied") {
        Notification.requestPermission().then((perm) => { if (perm === "granted") showNotification(); });
      }
    }

    socket.on('load_history', (messages) => {
      const chat = document.getElementById('chat');
      chat.innerHTML = '';
      messages.forEach(m => addMessage(m, m.username === username));
    });

    socket.on('receive_message', (m) => {
      addMessage(m, m.username === username);
      if (!isPageVisible) showNotification();
    });

    function addMessage(m, isSelf) {
      const chat = document.getElementById('chat');
      const container = document.createElement('div');
      container.classList.add('message-container', isSelf ? 'my-message' : 'other-message');
      container.dataset.id = m.id;

      const usernameDiv = document.createElement('div');
      usernameDiv.classList.add('username');
      usernameDiv.textContent = m.username;

      if (m.reply_to_id) {
        const replyPreview = document.createElement('div');
        replyPreview.classList.add('reply-preview');
        const original = document.querySelector(`.message-container[data-id='${m.reply_to_id}'] .bubble`);
        const originalUser = document.querySelector(`.message-container[data-id='${m.reply_to_id}'] .username`);
        replyPreview.textContent = original && originalUser ? `回覆 ${originalUser.textContent}: ${original.textContent}` : '';
        container.appendChild(replyPreview);
      }

      const bubbleDiv = document.createElement('div');
      bubbleDiv.classList.add('bubble');
      bubbleDiv.textContent = m.message;

      const metaDiv = document.createElement('div');
      metaDiv.classList.add('meta');

      const timeSpan = document.createElement('span');
      timeSpan.textContent = new Date(m.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      const replyBtn = document.createElement('button');
      replyBtn.classList.add('reply-button');
      replyBtn.textContent = '回覆';
      replyBtn.onclick = () => {
        replyToId = m.id;
        document.getElementById('message').placeholder = `回覆: ${m.message}`;
        document.getElementById('message').focus();
      };

      metaDiv.appendChild(timeSpan);
      metaDiv.appendChild(replyBtn);

      container.appendChild(usernameDiv);
      container.appendChild(bubbleDiv);
      container.appendChild(metaDiv);

      chat.appendChild(container);
      chat.scrollTop = chat.scrollHeight;
    }

    function send() {
      const messageInput = document.getElementById('message');
      const message = messageInput.value.trim();
      if (!message) return;
      socket.emit('send_message', { message: message, reply_to_id: replyToId });
      messageInput.value = '';
      messageInput.placeholder = '輸入訊息...';
      replyToId = null;
    }

    document.getElementById('message').addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        send();
      }
    });
  </script>
</body>
</html>
